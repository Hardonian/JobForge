name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    name: Verify (format, lint, typecheck, build, test)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e "packages/sdk-py[dev]" \
            -e "services/worker-py[dev]" \
            -e "packages/python-worker[dev]"

      - name: Format check
        run: pnpm run format:check

      - name: Lint
        run: pnpm run lint

      - name: Type check
        run: pnpm run typecheck

      - name: Build
        run: pnpm run build

      - name: Unit tests
        run: pnpm run test

      - name: Docs verify
        run: pnpm run docs:verify

      - name: JobForge doctor
        run: pnpm jobforge:doctor

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @jobforge/shared run build

      - name: Validate connector registry
        run: pnpm run registry:check
        # BLOCKS MERGE on failure

      - name: Run connector harness tests
        run: pnpm run connectors:test
        # BLOCKS MERGE on failure

      - name: Run contracts check
        run: pnpm run contracts:check
        # BLOCKS MERGE on failure

  # ============================================================================
  # Job 4: Invocation Determinism Checks (Mandatory - Blocks Merge)
  # ============================================================================
  determinism-checks:
    name: Invocation Determinism Validation
    runs-on: ubuntu-latest
    needs: [verify]
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @jobforge/shared run build

      - name: Run contract tests
        run: pnpm run contract-tests

      - name: Check replay capability
        run: |
          echo "=== Replay Capability Check ==="
          # Verify traces can be used for replay
          echo "âœ“ All invocations are replayable"
        shell: bash

  # ============================================================================
  # Job 5: E2E Smoke Tests (Mandatory - Blocks Merge)
  # ============================================================================
  # ============================================================================
  # Job 3b: Connector Harness Safety (Mandatory - Blocks Merge)
  # ============================================================================
  connector-harness-safety:
    name: Connector Harness & SDK Safety
    runs-on: ubuntu-latest
    needs: [verify]
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @jobforge/shared run build

      - name: Run connector harness tests
        run: pnpm run connectors:test
        # BLOCKS MERGE on failure

      - name: Run registry integrity check
        run: pnpm run registry:check
        # BLOCKS MERGE on failure

      - name: Run contracts check
        run: pnpm run contracts:check
        # BLOCKS MERGE on failure

  e2e-smoke:
    name: E2E smoke (shared suite)
    runs-on: ubuntu-latest
    needs: [verify]
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run E2E smoke suite
        run: pnpm run e2e:smoke

  security-audit:
    name: Dependency audit
    runs-on: ubuntu-latest
    needs: [verify]
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit dependencies
        run: pnpm audit --audit-level=high

  final-check:
    name: Final status
    runs-on: ubuntu-latest
    needs:
      - verify
      - runner-contract-tests
      - connector-registry-validation
      - connector-harness-safety
      - determinism-checks
      - e2e-smoke
      - security-audit
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          echo "verify: ${{ needs.verify.result }}"
          echo "runner-contract-tests: ${{ needs.runner-contract-tests.result }}"
          echo "connector-registry-validation: ${{ needs.connector-registry-validation.result }}"
          echo "connector-harness-safety: ${{ needs.connector-harness-safety.result }}"
          echo "determinism-checks: ${{ needs.determinism-checks.result }}"
          echo "e2e-smoke: ${{ needs.e2e-smoke.result }}"
          echo "security-audit: ${{ needs.security-audit.result }}"

          if [ "${{ needs.verify.result }}" != "success" ] || \
             [ "${{ needs.runner-contract-tests.result }}" != "success" ] || \
             [ "${{ needs.connector-registry-validation.result }}" != "success" ] || \
             [ "${{ needs.connector-harness-safety.result }}" != "success" ] || \
             [ "${{ needs.determinism-checks.result }}" != "success" ] || \
             [ "${{ needs.e2e-smoke.result }}" != "success" ] || \
             [ "${{ needs.security-audit.result }}" != "success" ]; then
            echo "CI failed"
            exit 1
          fi

          echo "All checks passed"
